<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.application.foodhub.post.PostDAO">

	<resultMap id="postMap" type="hashmap">
			<result column="POST_ID"  	   	property="postId"/>
			<result column="TITLE" 	   		property="title"/>
			<result column="CATEGORY_NM"	property="cateNm"/>
			<result	column="SUB_CATE_NM"	property="subCateNm"/>
			<result	column="CATEGORY_ID"	property="categoryId"/>
			<result	column="SUB_CATE_ID"	property="subCateId"/>
			<result column="CONTENT" 	   	property="content"/>
			<result column="VIEW_CNT" 	   	property="viewCnt"/>
			<result column="CREATED_AT" 	property="createdAt"/>
			<result column="USER_ID"       	property="userId"/>
			<result column="NICKNAME"     	property="nickname"/>
			<result column="PROFILE_UUID"  	property="profileUUID"/>
			<result column="FILE_UUID"		property="fileUUID"/>
			<result column="STATUS"			property="status"/>
	</resultMap>
	
	<insert id="createPost" parameterType="PostDTO" useGeneratedKeys="true" keyProperty="postId">
	    INSERT INTO POST (
	        USER_ID,
	        NICKNAME,
	        CATEGORY_ID,
	        CATEGORY_NM,
	        SUB_CATE_ID,
	        SUB_CATE_NM,
	        TITLE,
	        CONTENT,
	        CREATED_AT
	    ) VALUES (
	        #{userId},
	        #{nickname},
	        #{categoryId},
	        CASE 
	        	WHEN #{categoryId} = 0 THEN 'Í≥µÏßÄÏÇ¨Ìï≠'
	            WHEN #{categoryId} = 1 THEN 'Ïô∏ÏãùÏóÖÏ†ïÎ≥¥Í≤åÏãúÌåê'
	            WHEN #{categoryId} = 2 THEN 'ÏûêÏú†Í≤åÏãúÌåê'
	            WHEN #{categoryId} = 3 THEN 'ÏïåÎ∞îÍ≥µÍ≥†Í≤åÏãúÌåê'
	            WHEN #{categoryId} = 4 THEN 'ÏßàÎ¨∏Í≤åÏãúÌåê'
	            WHEN #{categoryId} = 5 THEN 'Ï§ëÍ≥†Ïû•ÎπÑÍ±∞ÎûòÍ≤åÏãúÌåê'
	            WHEN #{categoryId} = 6 THEN 'Îß§Ïû•ÌôçÎ≥¥Í≤åÏãúÌåê'
	            WHEN #{categoryId} = 7 THEN 'ÌòëÎ†•ÏóÖÏ≤¥Í≤åÏãúÌåê'
	            ELSE NULL
	        END,
	        #{subCateId},
	        CASE 
	            WHEN #{subCateId} = 0 THEN 'Í≥µÏßÄ'
	            WHEN #{subCateId} = 1 THEN 'Ïû°Îã¥'
	            WHEN #{subCateId} = 2 THEN 'ÏùºÏÉÅÏù¥ÏïºÍ∏∞'
	            WHEN #{subCateId} = 3 THEN 'ÏßàÎ¨∏'
	            WHEN #{subCateId} = 4 THEN 'ÏóÖÍ≥ÑÎâ¥Ïä§'
	            WHEN #{subCateId} = 5 THEN 'ÏóÖÏ≤¥ÏÜåÏãù'
	            WHEN #{subCateId} = 6 THEN 'Ìä∏Î†åÎìú'
	            WHEN #{subCateId} = 7 THEN 'ÏóÖÍ≥ÑÎ∂ÑÏÑù'
	            WHEN #{subCateId} = 8 THEN 'ÏÉàÎ°úÏö¥ ÎßõÏßë'
	            WHEN #{subCateId} = 9 THEN 'ÏßÅÏõê Íµ¨Ïù∏'
	            WHEN #{subCateId} = 10 THEN 'ÏïåÎ∞î Íµ¨Ïù∏'
	            WHEN #{subCateId} = 11 THEN 'Íµ¨ÏßÅ'
	            WHEN #{subCateId} = 12 THEN 'ÏóÖÍ≥Ñ ÏßàÎ¨∏'
	            WHEN #{subCateId} = 13 THEN 'ÏûêÏú† ÏßàÎ¨∏'
	            WHEN #{subCateId} = 14 THEN 'ÎèÑÏõÄ ÏöîÏ≤≠'
	            WHEN #{subCateId} = 15 THEN 'ÌåÅÏùÑ Íµ¨Ìï©ÎãàÎã§'
	            WHEN #{subCateId} = 16 THEN 'ÌåêÎß§'
	            WHEN #{subCateId} = 17 THEN 'ÎÇòÎàî'
	            WHEN #{subCateId} = 18 THEN 'ÍµêÌôò'
	            WHEN #{subCateId} = 19 THEN 'Íµ¨Îß§Ìù¨Îßù'
	            WHEN #{subCateId} = 20 THEN 'Îß§Ïû• ÏÜåÍ∞ú'
	            WHEN #{subCateId} = 21 THEN 'Ïã†Í∑ú Ïò§Ìîà'
	            WHEN #{subCateId} = 22 THEN 'Ïù¥Î≤§Ìä∏'
	            WHEN #{subCateId} = 23 THEN 'ÎßõÏßë Ï∂îÏ≤ú'
	            WHEN #{subCateId} = 24 THEN 'ÏóÖÏ≤¥ ÏÜåÍ∞ú'
	            WHEN #{subCateId} = 25 THEN 'ÌòëÎ†• ÏöîÏ≤≠'
	            ELSE NULL
	        END,
	        #{title},
	        #{content},
	        NOW()
	    )
	</insert>

	
	<!-- Ï°∞ÌöåÏàò Ï¶ùÍ∞Ä -->
	<update id="updateReadCnt" parameterType="long">
		UPDATE	POST
		SET		VIEW_CNT = VIEW_CNT + 1
		WHERE	POST_ID = #{postId}
	</update>
	
	
	<!-- Í≤åÏãúÍ∏Ä Ï†ïÎ≥¥Îßå Í∞ÄÏ†∏Ïò§Í∏∞ (ÌååÏùº Ï†úÏô∏) -->
	<select id="getPostDetail" parameterType="long" resultMap="postMap">
	    SELECT    P.POST_ID        AS POST_ID,
	              P.SUB_CATE_NM    AS SUB_CATE_NM,
	              P.TITLE          AS TITLE,
	              P.CATEGORY_ID    AS CATEGORY_ID,
	              P.SUB_CATE_ID    AS SUB_CATE_ID,
	              U.PROFILE_UUID   AS PROFILE_UUID,
	              U.USER_ID        AS USER_ID,
	              U.NICKNAME       AS NICKNAME,
	              P.CREATED_AT     AS CREATED_AT,
	              P.VIEW_CNT       AS VIEW_CNT,
	              P.CONTENT        AS CONTENT,
	              P.STATUS         AS STATUS
	    FROM      POST P
	    JOIN      USER U
	      ON      P.USER_ID = U.USER_ID
	    WHERE     P.POST_ID = #{postId}
	      AND     P.STATUS != 'DELETED'
	</select>
	
  	<!-- üîπ ÎßàÏù¥ÌéòÏù¥ÏßÄÏóêÏÑú ÎÇ¥Í∞Ä ÏûëÏÑ±Ìïú Í∏Ä Î™©Î°ù (ÏÇ≠Ï†úÎêú Í≤åÏãúÍ∏Ä Ï†úÏô∏) -->
    <select id="myPostList" parameterType="String" resultMap="postMap">
        SELECT  P.POST_ID AS POST_ID, 
                P.TITLE AS TITLE
        FROM    POST P
        JOIN    USER U ON P.USER_ID = U.USER_ID
        WHERE   P.USER_ID = #{userId}
        AND     P.STATUS != 'DELETED'  <!-- ‚úÖ ÏÇ≠Ï†úÎêú Í≤åÏãúÍ∏Ä Ï†úÏô∏ -->
    </select>
	
	<!-- Í≤åÏãúÍ∏Ä ÏÇ≠Ï†ú -->
	<update id="markPostAsDeleted">
	    UPDATE 	POST 
	    SET 	STATUS = 'DELETED'
	    WHERE 	POST_ID = #{postId}
	</update>
	
	<!-- Í≤åÏãúÍ∏Ä ÏàòÏ†ï -->
	<update id="updatePost" parameterType="PostDTO">
	    UPDATE 		POST 
	    SET    		CATEGORY_ID = #{categoryId},
	        		CATEGORY_NM = CASE 
	            		WHEN #{categoryId} = 1 THEN 'Ïô∏ÏãùÏóÖÏ†ïÎ≥¥Í≤åÏãúÌåê'
	            		WHEN #{categoryId} = 2 THEN 'ÏûêÏú†Í≤åÏãúÌåê'
	            		WHEN #{categoryId} = 3 THEN 'ÏïåÎ∞îÍ≥µÍ≥†Í≤åÏãúÌåê'
			            WHEN #{categoryId} = 4 THEN 'ÏßàÎ¨∏Í≤åÏãúÌåê'
			            WHEN #{categoryId} = 5 THEN 'Ï§ëÍ≥†Ïû•ÎπÑÍ±∞ÎûòÍ≤åÏãúÌåê'
			            WHEN #{categoryId} = 6 THEN 'Îß§Ïû•ÌôçÎ≥¥Í≤åÏãúÌåê'
			            WHEN #{categoryId} = 7 THEN 'ÌòëÎ†•ÏóÖÏ≤¥Í≤åÏãúÌåê'
			            ELSE CATEGORY_NM
       				END,
	        		SUB_CATE_ID = #{subCateId},
	        		SUB_CATE_NM = CASE 
	            		WHEN #{subCateId} = 1 THEN 'Ïû°Îã¥'
			            WHEN #{subCateId} = 2 THEN 'ÏùºÏÉÅÏù¥ÏïºÍ∏∞'
			            WHEN #{subCateId} = 3 THEN 'ÏßàÎ¨∏'
			            WHEN #{subCateId} = 4 THEN 'ÏóÖÍ≥ÑÎâ¥Ïä§'
			            WHEN #{subCateId} = 5 THEN 'ÏóÖÏ≤¥ÏÜåÏãù'
			            WHEN #{subCateId} = 6 THEN 'Ìä∏Î†åÎìú'
			            WHEN #{subCateId} = 7 THEN 'ÏóÖÍ≥ÑÎ∂ÑÏÑù'
			            WHEN #{subCateId} = 8 THEN 'ÏÉàÎ°úÏö¥ ÎßõÏßë'
			            WHEN #{subCateId} = 9 THEN 'ÏßÅÏõê Íµ¨Ïù∏'
			            WHEN #{subCateId} = 10 THEN 'ÏïåÎ∞î Íµ¨Ïù∏'
			            WHEN #{subCateId} = 11 THEN 'Íµ¨ÏßÅ'
			            WHEN #{subCateId} = 12 THEN 'ÏóÖÍ≥Ñ ÏßàÎ¨∏'
			            WHEN #{subCateId} = 13 THEN 'ÏûêÏú† ÏßàÎ¨∏'
			            WHEN #{subCateId} = 14 THEN 'ÎèÑÏõÄ ÏöîÏ≤≠'
			            WHEN #{subCateId} = 15 THEN 'ÌåÅÏùÑ Íµ¨Ìï©ÎãàÎã§'
			            WHEN #{subCateId} = 16 THEN 'ÌåêÎß§'
			            WHEN #{subCateId} = 17 THEN 'ÎÇòÎàî'
			            WHEN #{subCateId} = 18 THEN 'ÍµêÌôò'
			            WHEN #{subCateId} = 19 THEN 'Íµ¨Îß§Ìù¨Îßù'
			            WHEN #{subCateId} = 20 THEN 'Îß§Ïû• ÏÜåÍ∞ú'
			            WHEN #{subCateId} = 21 THEN 'Ïã†Í∑ú Ïò§Ìîà'
			            WHEN #{subCateId} = 22 THEN 'Ïù¥Î≤§Ìä∏'
			            WHEN #{subCateId} = 23 THEN 'ÎßõÏßë Ï∂îÏ≤ú'
			            WHEN #{subCateId} = 24 THEN 'ÏóÖÏ≤¥ ÏÜåÍ∞ú'
			            WHEN #{subCateId} = 25 THEN 'ÌòëÎ†• ÏöîÏ≤≠'
			            ELSE SUB_CATE_NM
	        		END,
	        		TITLE = #{title},
	        		CONTENT = #{content},
	        		UPDATED_AT = NOW()
	    WHERE 		POST_ID = #{postId}
	</update>
	
	<!-- Ïù¥Ï†ÑÍ∏Ä Îã§ÏùåÍ∏ÄÏùÑ ÎàåÎ†ÄÏùÑÎïå Ïπ¥ÌÖåÍ≥†Î¶¨ ÏïÑÏù¥ÎîîÍ∞Ä Í∞ôÏùÄ Í≤ΩÏö∞Ïùò postId Í∞ÄÏ†∏Ïò§Í∏∞ -->
	<select id="getPrevPostId" resultType="long">
		<![CDATA[
		 	SELECT 		POST_ID
	     	FROM 		POST
		    WHERE 		POST_ID  <  #{postId} 
	      	AND 		CATEGORY_ID = #{categoryId}
	      	AND 		STATUS != 'DELETED'
	      	ORDER BY 	POST_ID DESC
		    LIMIT 1
	    ]]>
	</select>
	
	<select id="getNextPostId" resultType="long">
		<![CDATA[
		    SELECT 		POST_ID
		    FROM 		POST
		    WHERE 		POST_ID > #{postId} 
	      	AND 		CATEGORY_ID = #{categoryId}  
	      	AND 		STATUS != 'DELETED'
		    ORDER BY 	POST_ID ASC
		    LIMIT 1
	    ]]>	    
	</select>
	
	<!-- Ïπ¥ÌÖåÍ≥†Î¶¨ ÏïÑÏù¥ÎîîÎ°ú Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶Ñ Î∂àÎü¨Ïò§Í∏∞ -->
	<select id="getCategoryNameById" resultType="String">
	    SELECT 			CATEGORY_NM 
	    FROM 			POST_CATEGORY 
	    WHERE 			CATEGORY_ID = #{categoryId}
	</select>
	
	<!-- üîπ Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÏµúÏã† Í≤åÏãúÍ∏Ä 2Í∞ú Í∞ÄÏ†∏Ïò§Í∏∞ (ÏÇ≠Ï†úÎêú Í≤åÏãúÍ∏Ä Ï†úÏô∏) -->
    <select id="getLatestPostsByCategoryId" resultMap="postMap">
        SELECT  	P.POST_ID 					AS POST_ID,
                	P.CATEGORY_NM 				AS CATEGORY_NM,
                	S.SUB_CATE_NM 				AS SUB_CATE_NM, 
                	P.TITLE 					AS TITLE, 
                	U.NICKNAME 					AS NICKNAME, 
                	P.CREATED_AT 				AS CREATED_AT, 
                	COALESCE(L.LIKE_COUNT, 0) 	AS LIKE_COUNT
        FROM    	POST P
        JOIN    	USER U 
        ON 			P.USER_ID = U.USER_ID
        JOIN    	SUB_CATEGORY S 
        ON 			P.SUB_CATE_ID = S.SUB_CATE_ID
        LEFT JOIN 	(
            		SELECT 		POST_ID, 
           						COUNT(*) 	AS LIKE_COUNT 
            		FROM 		POST_LIKE 
            		GROUP BY 	POST_ID
       				) AS L 
		ON 			P.POST_ID = L.POST_ID
        WHERE   	P.CATEGORY_ID = #{categoryId}
        AND     	P.STATUS != 'DELETED' 
        ORDER BY 	P.CREATED_AT DESC
        LIMIT   	#{limit}
    </select>
	
	<!-- Í≤åÏãúÍ∏Ä Í≤ÄÏÉâ -->
	<select id="searchPosts" resultMap="postMap">
	    SELECT  		P.POST_ID				  	AS POST_ID, 
	            		P.TITLE					  	AS TITLE, 
	            		U.NICKNAME				  	AS NICKNAME, 
	            		P.CREATED_AT			  	AS CREATED_AT, 
	            		P.VIEW_CNT				  	AS VIEW_CNT, 
	            		COALESCE(L.LIKE_COUNT, 0) 	AS LIKE_COUNT
	    FROM    		POST P
	    JOIN    		USER U 
	    ON 				P.USER_ID = U.USER_ID
	    LEFT JOIN 		(  
				        SELECT 		POST_ID, 
				        			COUNT(*) 	AS LIKE_COUNT 
				        FROM 		POST_LIKE 
				        GROUP BY 	POST_ID
				    	) AS L 
	    ON 				P.POST_ID = L.POST_ID
	    WHERE  	 		P.STATUS != 'DELETED'
	    
	    <if test="categoryId != null">
	        AND 		P.CATEGORY_ID = #{categoryId}
	    </if>
	    
	    <if test="subCateId != null">
	        AND 		P.SUB_CATE_ID = #{subCateId}
	    </if>
	    
	    <if test="keyword != null and keyword != ''">
	        <choose>
	            <when test="searchType == 'title'">
	                AND 	P.TITLE LIKE CONCAT('%', #{keyword}, '%')
	            </when>
	            <when test="searchType == 'title_content'">
	                AND 	(P.TITLE LIKE CONCAT('%', #{keyword}, '%') OR P.CONTENT LIKE CONCAT('%', #{keyword}, '%'))
	            </when>
	        </choose>
	    </if>
	    
	    ORDER BY 
		    <choose>
		        <when test="isBest">
		            LIKE_COUNT DESC, 
		            P.CREATED_AT DESC
		        </when>
		        <otherwise>
		            P.CREATED_AT DESC
		        </otherwise>
		    </choose>
	    
	    LIMIT 		#{pageSize} OFFSET #{offset}
	</select>
	
	
	
	<!-- ÏÑúÎ∏å Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶Ñ Í∞ÄÏ†∏Ïò§Í∏∞ -->
	<select id="getSubCateNameById" resultType="String">
	    SELECT 	SUB_CATE_NM 
	    FROM 	SUB_CATEGORY 
	    WHERE 	SUB_CATE_ID = #{subCateId}
	</select>
	
	<!-- ÏÑúÎ∏å Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Í≤åÏãúÍ∏Ä Î¶¨Ïä§Ìä∏ -->
	<select id="getPostListBySubCategory" resultMap="postMap">
	    SELECT 	P.POST_ID, 
	    		P.CATEGORY_ID,
	    		P.SUB_CATE_ID,
	    		P.SUB_CATE_NM, 
	    		P.TITLE, U.NICKNAME, 
	    		P.CREATED_AT, 
	    		P.VIEW_CNT, 
	    		COALESCE(L.LIKE_COUNT, 0) AS LIKE_COUNT
	    FROM 	POST P
	    JOIN 	USER U 
	    ON 		P.USER_ID = U.USER_ID
	    LEFT 	JOIN (
		        	SELECT 		POST_ID, 
	        					COUNT(*) 	AS LIKE_COUNT 
		        	FROM 		POST_LIKE 
		        	GROUP BY 	POST_ID
	    		) AS L 
	    ON 		P.POST_ID = L.POST_ID
	    WHERE 	P.SUB_CATE_ID = #{subCateId} 
	    AND 	P.STATUS != 'DELETED' 
	    ORDER 	BY P.CREATED_AT DESC
	    LIMIT 	#{pageSize} 
	    OFFSET 	#{offset}
	</select>
	
	<!-- Í≤åÏãúÍ∏Ä Î™®ÏïÑÎ≥¥Í∏∞ÏóêÏÑú ÌéòÏßÄÏù¥ ÏÉùÏÑ±ÏùÑ ÏúÑÌïú Í≤åÏãúÍ∏Ä count -->
	<select id="countPosts" resultType="long">
	    SELECT 		COUNT(*) 
	    FROM 		POST
	    WHERE 		STATUS != 'DELETED'
	    <if test="keyword != null and keyword != ''">
	        <if test="searchType == 'title'">
	            AND 	TITLE LIKE CONCAT('%', #{keyword}, '%')
	        </if>
	        <if test="searchType == 'title_content'">
	            AND 	(TITLE LIKE CONCAT('%', #{keyword}, '%') 
	            OR 		CONTENT LIKE CONCAT('%', #{keyword}, '%'))
	        </if>
	    </if>
	    <if test="categoryId != null">
	        AND 	CATEGORY_ID = #{categoryId}
	    </if>
	    <if test="subCateId != null">
	        AND 	SUB_CATE_ID = #{subCateId}
	    </if>
	</select>
	
	<!-- Ìï¥Îãπ Ï†ïÎ≥¥Ïóê Î∂ÄÌï©ÌïòÎäî Í≤åÏãúÍ∏Ä Î∂àÎü¨Ïò§Í∏∞ -->
	<select id="getPostList" resultMap="postMap">
	    SELECT  	P.POST_ID 					AS POST_ID,
	            	P.TITLE 					AS TITLE,
	            	P.CREATED_AT 				AS CREATED_AT,
	            	P.VIEW_CNT 					AS VIEW_CNT,
	            	U.NICKNAME 					AS NICKNAME,
	            	S.SUB_CATE_NM 				AS SUB_CATE_NM,
	            	COALESCE(L.LIKE_COUNT, 0) 	AS LIKE_COUNT
	    FROM    	POST P
	    JOIN    	USER U 
	    ON 			P.USER_ID = U.USER_ID
	    JOIN 		SUB_CATEGORY S 
	    ON 			P.SUB_CATE_ID = S.SUB_CATE_ID
	    LEFT JOIN 	(  
			        SELECT POST_ID, COUNT(*) AS LIKE_COUNT 
			        FROM POST_LIKE 
			        GROUP BY POST_ID
				    ) AS L 
	    ON 			P.POST_ID = L.POST_ID
    	WHERE   	P.STATUS != 'DELETED'
	    <if test="keyword != null and keyword != ''">
	        <if test="searchType == 'title'">
	            AND 	P.TITLE LIKE CONCAT('%', #{keyword}, '%')
	        </if>
	        <if test="searchType == 'title_content'">
	            AND 	(P.TITLE LIKE CONCAT('%', #{keyword}, '%') 
	            OR 		P.CONTENT LIKE CONCAT('%', #{keyword}, '%'))
	        </if>
	    </if>
	    <if test="categoryId != null">
	        AND 	P.CATEGORY_ID = #{categoryId}
	    </if>
	    <if test="subCateId != null">
	        AND 	P.SUB_CATE_ID = #{subCateId}
	    </if>
	    ORDER BY 
		    <choose>
		        <when test="orderType == 'best'">
		            LIKE_COUNT DESC, 
		            P.CREATED_AT DESC
		        </when>
		        <otherwise>
		            P.CREATED_AT DESC
		        </otherwise>
		    </choose>
	    LIMIT 	#{pageSize} 
	    OFFSET 	#{offset}
	</select>

	

</mapper>